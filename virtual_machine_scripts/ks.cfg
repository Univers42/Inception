# RHEL Kickstart Example for Automated Server Install

# System language and keyboard
lang en_US.UTF-8
keyboard es

# Network configuration
network --device=link --bootproto=dhcp --hostname=dlesieur

# Install from DVD and expose repos (RHEL 9 DVD layout)
cdrom
repo --name="BaseOS" --baseurl=file:///run/install/repo/BaseOS
repo --name="AppStream" --baseurl=file:///run/install/repo/AppStream

# Ensure fully automated install
text
cmdline
console=ttyS0,115200n8
eula --agreed
firstboot --disable
services --enabled=sshd,firewalld
reboot

# Timezone
timezone Europe/Madrid --isUtc

# Root password (plaintext for demo, use --iscrypted for production)
rootpw temproot123

# User creation
user --name=dlesieur --password=tempuser123 --gecos="dlesieur" --groups=wheel

# SELinux
selinux --enforcing

# Firewall
firewall --enabled --service=ssh

# System authorization
auth --useshadow --passalgo=sha512

# Bootloader
bootloader --location=mbr --driveorder=sda --append="crashkernel=auto"

# Partitioning - replace autopart with explicit encrypted LVM layout
ignoredisk --only-use=sda
zerombr
clearpart --all --initlabel
part /boot --fstype=ext4 --size=500 --ondisk=sda
part pv.01 --size=1 --grow --ondisk=sda --encrypted --passphrase=tempencrypt123
volgroup LVMGroup pv.01
logvol /         --vgname=LVMGroup --name=root    --fstype=ext4 --size=10000
logvol swap      --vgname=LVMGroup --name=swap    --fstype=swap --size=2300
logvol /home     --vgname=LVMGroup --name=home    --fstype=ext4 --size=5000
logvol /var      --vgname=LVMGroup --name=var     --fstype=ext4 --size=3000
logvol /srv      --vgname=LVMGroup --name=srv     --fstype=ext4 --size=3000
logvol /tmp      --vgname=LVMGroup --name=tmp     --fstype=ext4 --size=3000
logvol /var/log  --vgname=LVMGroup --name=var-log --fstype=ext4 --size=4000

# Optional: Custom partitioning (commented out)
# part /boot --fstype="xfs" --size=500
# part pv.01 --size=1 --grow
# volgroup VolGroup --pesize=4096 pv.01
# logvol / --vgname=VolGroup --size=10000 --name=root --fstype="xfs"
# logvol /home --vgname=VolGroup --size=5000 --name=home --fstype="xfs"
# logvol swap --vgname=VolGroup --size=2300 --name=swap

# Packages selection
%packages
@^minimal-environment
openssh-server
sudo
firewalld
policycoreutils-python-utils
%end

# Post-install configuration
%post --log=/root/ks-post.log
cat > /root/post_install.sh <<'EOSH'
#!/usr/bin/env bash
set -euo pipefail

# Ensure required tools
dnf -y install libpwquality policycoreutils-python-utils || true

# Sudo policy and logging
mkdir -p /var/log/sudo
cat >/etc/sudoers.d/sudo_config <<'EOF'
Defaults        passwd_tries=3
Defaults        badpass_message="Incorrect password. Access denied."
Defaults        logfile="/var/log/sudo/sudo.log"
Defaults        log_input,log_output
Defaults        requiretty
Defaults        secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin"
EOF
chmod 440 /etc/sudoers.d/sudo_config

# User group
usermod -aG wheel dlesieur || true

# SSH hardening and port change
sed -i -E 's/^\s*#?\s*Port\s+.*/Port 4242/' /etc/ssh/sshd_config
sed -i -E 's/^\s*#?\s*PermitRootLogin\s+.*/PermitRootLogin no/' /etc/ssh/sshd_config
systemctl enable sshd

# Firewall and SELinux for custom SSH port
systemctl enable --now firewalld || true
firewall-cmd --permanent --add-port=4242/tcp || true
if command -v semanage >/dev/null 2>&1; then
  semanage port -a -t ssh_port_t -p tcp 4242 2>/dev/null || \
  semanage port -m -t ssh_port_t -p tcp 4242 || true
fi
firewall-cmd --reload || true
systemctl restart sshd || true

# Password policy
sed -i -E 's/^PASS_MAX_DAYS.*/PASS_MAX_DAYS\t30/' /etc/login.defs || true
sed -i -E 's/^PASS_MIN_DAYS.*/PASS_MIN_DAYS\t2/' /etc/login.defs || true

echo "Post-install completed. Consider resetting passwords:"
echo "  sudo passwd root"
echo "  sudo passwd dlesieur"
EOSH
chmod +x /root/post_install.sh
bash /root/post_install.sh
%end